{% extends "base.html" %}
{% block content %}

<div class="container">
  <br>
  <div class="row">
    <!-- Left: Upload + Preview -->
    <div class="col-md-6 classy_frame">
      <center><h3>Classify Your Waste Material</h3></center>
      <img id="preview" src="{{ url_for('static', filename='images/reuse.png') }}" height="400px" width="100%" alt="Preview Image">

      <center><br>
        <div class="image-upload">
          <p id="upload-web">Click the image icon to upload a photo.</p>
          <p id="upload-mobile">Tap the camera icon to capture a photo.</p>

          <label for="file">
            <img id="upload-web" src="{{ url_for('static', filename='images/upload.png') }}" />
            <img id="upload-mobile" src="{{ url_for('static', filename='images/camera.png') }}" />
          </label>
          <input type="file" id="file" onchange="previewImage()">
        </div>

        <br>
        <button class="classify-button" onclick="classifyWaste()">Classify your waste material</button>
      </center>
      <br>
    </div>

    <!-- Right: Prediction & Description -->
    <div class="col-md-6 classy_frame" id="about">
      <center><h3>About</h3></center>
      <h4>This app helps you classify waste into 6 categories using AI. Upload an image to find out what type of material it is and learn how it can be recycled.</h4>
    </div>
  </div>

  <!-- Video Results Section (hidden initially) -->
  <div class="row" id="recycling-videos" style="display: none;">
    <hr>
    <h3 id="video-title"></h3>
    <div class="col-md-6 classy_frame">
      <div class="embed-responsive embed-responsive-16by9">
        <iframe id="video1" width="100%" height="315" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
    <div class="col-md-6 classy_frame">
      <div class="embed-responsive embed-responsive-16by9">
        <iframe id="video2" width="100%" height="315" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
  </div>
</div>

<script>
  var imgData;
  var loading = document.getElementById("loading");
  var recyclingVideos = document.getElementById("recycling-videos");

  recyclingVideos.style.display = "none";

  function previewImage() {
    var file = document.getElementById("file").files;
    if (file.length > 0) {
      var fileName = file[0].name;
      var allowed_extensions = ["jpeg", "jpg", "png"];
      var ext = fileName.split('.').pop().toLowerCase();

      if (allowed_extensions.includes(ext)) {
        var fileReader = new FileReader();
        fileReader.onload = function(event) {
          document.getElementById("preview").setAttribute("src", event.target.result);
          imgData = event.target.result;
        };
        fileReader.readAsDataURL(file[0]);
      } else {
        document.getElementById("file").value = "";
        document.getElementById("errorTitle").innerHTML = "Only Image Files Allowed";
        document.getElementById("errorMessage").innerHTML = "Please upload a .jpg, .jpeg or .png file.";
        $("#errorPopup").modal("show");
      }
    }
  }

  function classifyWaste() {
    var file = document.getElementById("file").files;
    if (file.length > 0) {
      loading.style.display = "block";

      var form_data = new FormData();
      form_data.append("file", file[0]);

      $.ajax({
        url: '/classifywaste',
        dataType: 'json',
        cache: false,
        contentType: false,
        processData: false,
        data: form_data,
        type: 'POST',
        success: function(data) {
          var predicted_value = data["predicted_value"];
          var details = data["details"];
          var video1 = data["video1"];
          var video2 = data["video2"];

          var about = document.getElementById("about");
          var videoTitle = document.getElementById("video-title");

          about.innerHTML = "<center><h3>Waste classified as <b style='background-color: #0b2438;'>" +
            predicted_value + "</b></h3></center><h4>" + details + "</h4>";

          videoTitle.innerHTML = "How " + predicted_value + " Recycling Works";
          document.getElementById("video1").setAttribute("src", "https://www.youtube.com/embed/" + video1);
          document.getElementById("video2").setAttribute("src", "https://www.youtube.com/embed/" + video2);

          recyclingVideos.style.display = "block";
          loading.style.display = "none";
        }
      });
    } else {
      document.getElementById("errorTitle").innerHTML = "No Image Uploaded";
      document.getElementById("errorMessage").innerHTML = "Please upload a waste image to classify.";
      $("#errorPopup").modal("show");
    }
  }
</script>

{% endblock %}
